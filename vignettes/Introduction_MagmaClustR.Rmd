---
title: "Introduction_MagmaClustR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction_MagmaClustR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<div style="text-align: justify"> 

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(MagmaClustR)
set.seed(5) # for exact reproducibility


```

## Abstract

The package *MagmaClustR* is based on the algorithms **MAGMA** and **MAGMACLUST**  presented in the paper 'MAGMA: Inference and Prediction with Multi-Task Gaussian Processes' and 'Cluster-Specific Predictions with Multi-Task Gaussian Processes' that you can find respectivly at the addresses : 

* https://arxiv.org/pdf/2007.10731.pdf 

* https://arxiv.org/pdf/2011.07866.pdf 


Thus, the package has two part, the inference and prediction with a multi-task Gaussian process framework and a clustering, and prediction for multiple functional data. 


This vignette will serve to introduce you the main features of MagmaClustR and how to use it. 

## Introduction 

The algorithm **MAGMA** use a common mean function and a specific covariance structure. This common mean is defined as a Gaussian process for which the hyper-posterior distribution is tractable. Therefore an EM algorithm can be derived for simultaneous hyper-parameters optimization and hyper-posterior computation. 

**MAGMACLUST** differs by using more than one common mean processes, and a variational EM algorithm is derived for dealing with the optimization of the hyper-parameters along with the hyper-posteriorsâ€™ estimation of latent variables and processes.
 

## Initialization 

Before testing the algorithms you should have your data as a tibble or data frame, with 3 columns required: 'ID', 'Input' and 'Output'. Additional columns for covariates can be specified. The 'Input' column should define the variable that is used as reference for the observations (e.g. time for longitudinal data). The 'Output' column specifies the observed values (the response variable). The data frame can also provide as many covariates as desired, with no constraints on the column names. These covariates are additional inputs (explanatory variables) of the models that are also observed at each reference 'Input'.

The *MagmaClustR* package provided some functions to test the packages with random values. The function *simu_db* make a tibble with M individuals with N observations per individual (M=N=10 by default). See `help(simu_db)` to the details of all the parameters. 

```{r setup}
simu_db(N=3)
```

You can set the *covariate* to FALSE if you want your database with 1D explanatory variables.

```{r}
simu_db(N=5, M=1, covariate = FALSE)
```


The algorithm uses GPs with gaussian mean process, with kernel methods. You must provide hyper-parameters coherent with your kernel. By default, the set of kernels and hyper-parameters associated are for the Squared Exponential kernel.
For more information of the kernels you can read  **The Kernel Cookbook: Advice on Covariance functions** by David Duvenaud (https://www.cs.toronto.edu/~duvenaud/cookbook/)

```{r}
hp()
hp("LIN")
hp("RQ")
```

We see above the format needed for the Squared Exponential Kernel, the Linear Kernel or the Rational Quadratic kernel. See the helper of the function *hp* ( `help(hp)`)to see the defaults kernel and the formats needed. 

##MAGMA Algorithm

The algorithm can basically be done in two part, the training and the prediction. 

```{r}
data_train <- simu_db(covariate = FALSE)

training <- train_magma(data = data_train)

```

```{r}
data_pred_1D <- simu_db(M=1, covariate = FALSE)

pred <- pred_magma(data = data_pred_1D, trained_model = training)
```

A plot of the prediction is on by default but can be removed when *plot* is set to **FALSE**. We can also have a heatmap to replace the curve when we are in 2D. Futhermore, once the training done, you can make more prediction with the same training. 

```{r}
data_pred_2D <- simu_db(M=1, covariate = TRUE)

pred <- pred_magma(data = data_pred_2D, trained_model = training)
```

See `help(train_magma)`, `help(pred_magma)` and `help(hyperposterior)` to understand and change all the parameters. 

You can plot a gif of your prediction with magma with the function *plot_gif*. 
```{r}
prediction_gif <- pred_gif(data_pred_1D, trained_model = training)
plot_gif(prediction_gif)
```

##MAGMAClust Algorithm

The algorithm can also basically be done in two part, the training and the prediction. 

```{r, warning=FALSE}
training_clust <- train_magma_VEM(data = data_train)
```

```{r}
pred_clust_1D <- pred_magma_clust(data_obs = data_pred_1D, trained_magmaclust = training_clust)
```

A plot of the prediction is on by default but can be removed when *plot* is set to **FALSE**. We can also have a heatmap to replace the curve when we are in 2D. 

```{r}
pred_clust_2D <- pred_magma(data = data_pred_2D, trained_model = training_clust)
```

See `help(train_magma_VEM)` and `help(pred_magma_clust)` to understand and change all the parameters. 

You can also plot the prediction of Magmaclust anytime with plot_magma_clust. 

```{r}
plot_magma_clust(pred_clust_1D)
```
