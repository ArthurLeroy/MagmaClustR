<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="MagmaClustR">
<title>How to use MagmaClust • MagmaClustR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to use MagmaClust">
<meta property="og:description" content="MagmaClustR">
<meta property="og:image" content="https://arthurleroy.github.io/MagmaClustR/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">MagmaClustR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/example-in-2D.html">Multi-dimensional inputs in Magma</a>
    <a class="dropdown-item" href="../articles/how-to-use-magma.html">How to use Magma</a>
    <a class="dropdown-item" href="../articles/how-to-use-magmaclust.html">How to use MagmaClust</a>
    <a class="dropdown-item" href="../articles/standard-GP.html">Gaussian Process regression</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ArthurLeroy/MagmaClustR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>How to use MagmaClust</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ArthurLeroy/MagmaClustR/blob/HEAD/vignettes/articles/how-to-use-magmaclust.Rmd" class="external-link"><code>vignettes/articles/how-to-use-magmaclust.Rmd</code></a></small>
      <div class="d-none name"><code>how-to-use-magmaclust.Rmd</code></div>
    </div>

    
    
<style>
body {
text-align: justify}
</style>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ArthurLeroy/MagmaClustR" class="external-link">MagmaClustR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/is_installed.html" class="external-link">is_installed</a></span><span class="op">(</span><span class="st">"gridExtra"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span><span class="op">}</span></span></code></pre></div>
<div class="section level2">
<h2 id="data-and-purpose">Data and purpose<a class="anchor" aria-label="anchor" href="#data-and-purpose"></a>
</h2>
<div class="section level3">
<h3 id="context">Context<a class="anchor" aria-label="anchor" href="#context"></a>
</h3>
<p>To explore the features of MagmaClust, we use the <code>weight</code>
dataset available <a href="https://github.com/ArthurLeroy/MAGMAclust/blob/master/Real_Data_Study/Data/db_gusto_weight.csv" class="external-link">here</a>,
coming from the GUSTO cohort study (<a href="https://www.gusto.sg/" class="external-link uri">https://www.gusto.sg/</a>) and more thoroughly studied <a href="https://arxiv.org/abs/2011.07866" class="external-link">here</a>). This dataset contains
3629 weight measurements of Singaporean children (174 boys and 168
girls, respectively).</p>
<p>Throughout this example, we use <em>MagmaClust</em> to model and
forecast evolution of children’s weight during early childhood. This
extension of the <em>Magma</em> model has been proposed to take into
account the presence of group structures in within data (a similar
vignette for Magma is available <a href="https://arthurleroy.github.io/MagmaClustR/articles/how-to-use-magma.html">here</a>)
to enhance predictions.</p>
<p>More generally, our aim is to train a model on a dataset containing
multiple individuals and predict a new individual’s weight thanks to
shared information within clusters.</p>
<p>To get a better idea of the <code>weight</code> dataset content, we
display an illustration of the observed data for 5 children. Do the
children’s weights evolve the same, <em>i.e.</em> with the same pattern?
Can we identify group structures in the data, and define appropriate
clusters? Those are the kind of questions we aim to tackle in the
following.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">list_ID</span> <span class="op">&lt;-</span> <span class="va">weight</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">weight</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">list_ID</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Input</span>,y<span class="op">=</span><span class="va">Output</span>,colour<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="how-to-use-magmaclust_files/figure-html/unnamed-chunk-3-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>This plot underlines the regularity of our functional data. The
values of weight are observed at the same ages for all children, as
measurements are collected in the context of a standardised cohort
study. Let us note that MagmaClust can also be used in the case of
irregular input grids without any change.</p>
<p>Overall, we can notice some differences in children profiles; some
are plump at birth before their weight gain slows down quickly, while
others may born slightly thinner but grow faster. Therefore, it might be
important to take these profiles into account if one wants to improve
the quality of weight predictions.</p>
</div>
<div class="section level3">
<h3 id="data-formatting">Data formatting<a class="anchor" aria-label="anchor" href="#data-formatting"></a>
</h3>
<p>The <code>weight</code> dataset contains 4 columns: <code>ID</code>,
<code>sex</code>, <code>Input</code> and <code>Output</code>. Each row
corresponds to the weight measured for on child at a given age. More
specifically, each column contains: - <code>ID</code>, the identifying
number associated with each child; - <code>sex</code>, a factor
indicating the biological gender of the child (<code>Male</code> or
<code>Female</code>); - <code>Input</code>, the age of the child (in
months); - <code>Output</code>, the weight of the child (in
kilograms).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">ID</th>
<th align="left">sex</th>
<th align="right">Input</th>
<th align="right">Output</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">010-04004</td>
<td align="left">Female</td>
<td align="right">0</td>
<td align="right">2.825</td>
</tr>
<tr class="even">
<td align="left">010-04004</td>
<td align="left">Female</td>
<td align="right">3</td>
<td align="right">5.058</td>
</tr>
<tr class="odd">
<td align="left">010-04004</td>
<td align="left">Female</td>
<td align="right">6</td>
<td align="right">6.622</td>
</tr>
<tr class="even">
<td align="left">010-04004</td>
<td align="left">Female</td>
<td align="right">9</td>
<td align="right">7.368</td>
</tr>
<tr class="odd">
<td align="left">010-04004</td>
<td align="left">Female</td>
<td align="right">12</td>
<td align="right">7.525</td>
</tr>
<tr class="even">
<td align="left">010-04004</td>
<td align="left">Female</td>
<td align="right">18</td>
<td align="right">8.900</td>
</tr>
</tbody>
</table>
<p>If new variables (such as height, morphology, percentage of muscle
mass …) would have been observed, any additional column would be treated
as a covariate, and thus result in a model with multi-dimensional
inputs.</p>
<p>Before starting to use <em>MagmaClust</em>, we must ensure that our
dataset contains at least the three following mandatory columns with
adequate type: - <code>ID</code>: <code>character</code> or
<code>factor</code>; - <code>Input</code>: <code>numeric</code>; -
<code>Output</code>: <code>numeric</code>.</p>
<p>Since the children weight is not particularly affected by gender
between 0 and 5 years old, we chose to maintain all individuals in the
same dataset. Therefore, the <code>sex</code> column is below removed
for simplicity.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weight</span> <span class="op">&lt;-</span> <span class="va">weight</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sex</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="classical-pipeline">Classical pipeline<a class="anchor" aria-label="anchor" href="#classical-pipeline"></a>
</h2>
<p>The overall process of the <em>MagmaClust</em> algorithm can be
decomposed in 3 main steps: <strong>training, prediction</strong> and
<strong>display of results</strong>. The corresponding functions
are:</p>
<ul>
<li><a href="https://arthurleroy.github.io/MagmaClustR/reference/train_magmaclust.html"><code>train_magmaclust()</code></a></li>
<li><a href="https://arthurleroy.github.io/MagmaClustR/reference/pred_magmaclust.html"><code>pred_magmaclust()</code></a></li>
<li><a href="https://arthurleroy.github.io/MagmaClustR/reference/plot_magmaclust.html"><code>plot_magmaclust()</code></a></li>
</ul>
</div>
<div class="section level2">
<h2 id="apply-magmaclust-on-the-weight-database">Apply MagmaClust on the weight database<a class="anchor" aria-label="anchor" href="#apply-magmaclust-on-the-weight-database"></a>
</h2>
<div class="section level3">
<h3 id="data-organisation">Data organisation<a class="anchor" aria-label="anchor" href="#data-organisation"></a>
</h3>
<p>Once the data organisation step is done, we randomly select two types
of children:</p>
<ul>
<li>those we use to train the model;</li>
<li>the one for whom we predict future performances; let’s give her the
fictive name <em>James</em>.</li>
</ul>
<p>To limit computation time in this illustrative example, we randomly
select 20 children for training. Even if the performances of
<em>MagmaClust</em> increase with the number of training individuals, 20
are more than enough to get a clear idea of how the algorithm works.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weight_train</span> <span class="op">&lt;-</span> <span class="va">weight</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">list_ID</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">weight_pred</span> <span class="op">&lt;-</span> <span class="va">weight</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">==</span> <span class="va">list_ID</span><span class="op">[</span><span class="fl">261</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Input</span><span class="op">&lt;</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">weight_test</span> <span class="op">&lt;-</span> <span class="va">weight</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">==</span> <span class="va">list_ID</span><span class="op">[</span><span class="fl">261</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Input</span><span class="op">&gt;</span><span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">weight_train</span>,</span>
<span>       mapping <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Input</span>,y<span class="op">=</span><span class="va">Output</span>,colour<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">1.5</span>,alpha<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">weight_pred</span>,</span>
<span>             size<span class="op">=</span><span class="fl">3</span>,</span>
<span>             shape<span class="op">=</span><span class="fl">17</span>,</span>
<span>             col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="how-to-use-magmaclust_files/figure-html/unnamed-chunk-7-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>The triangles correspond to James’ weight at different ages, whereas
the coloured dots are the children’ data we use for training.</p>
</div>
<div class="section level3">
<h3 id="training">Training<a class="anchor" aria-label="anchor" href="#training"></a>
</h3>
<p>It’s now time to train the model thanks to
<code><a href="../reference/train_magmaclust.html">train_magmaclust()</a></code>, for which several arguments can be
specified:</p>
<ul>
<li><p><code>nb_cluster</code>: as for any clustering method, we have to
provide a number <em>K</em> of clusters as an hypothesis of the model.
For illustration purposes, we arbitrarily set <span class="math inline">\(K = 3\)</span> in the following example. However,
a dedicated model selection method based on maximising a VBIC criterion
is provided in the package as <a href="https://arthurleroy.github.io/MagmaClustR/reference/select_nb_clusters.html"><code>select_nb_clusters()</code></a>.</p></li>
<li><p><code>kern</code>: the relationship between observed data and
prediction targets can be control through the covariance
<strong>kernel</strong>. Therefore, in order to correctly fit our data,
we need to choose a suitable covariance kernel. In the case of swimmers,
we want a smooth progression curve for James; therefore, we specify
<code>kern = "SE"</code>.</p></li>
</ul>
<p>The most commonly used kernels and their properties are discussed in
<a href="https://www.cs.toronto.edu/~duvenaud/cookbook/" class="external-link">the kernel
cookbook</a>. Details of available kernels and how to combine them are
available in <a href="https://arthurleroy.github.io/MagmaClustR/reference/train_magma.html"><code>help(train_magma)</code></a>.</p>
<ul>
<li><p><code>common_hp_k</code>: here, we assume that the set of
hyper-parameters is the same for each cluster by setting
<code>common_hp_k = TRUE</code>. Thus, we suppose that all clusters
share the same covariance structure. This property implies that the
shapes and variations of the curves are assumed to be roughly identical
from one cluster to another; the differentiation is mainly due to the
mean values.</p></li>
<li><p><code>common_hp_i</code>: as we want to share information across
children, we specify <code>common_hp_i = TRUE</code>. If this assumption
may appear restrictive at first glance, it actually offers a valuable
way to share common patterns between tasks.</p></li>
</ul>
<p>As for any GP method, initialisation of the HP may have an influence
on the final optimisation and leads to inadequate prediction for
pathological cases. Therefore, users may explicitly define specific
initial values through the dedicated arguments: <code>ini_hp_k</code>
and <code>ini_hp_i</code>.</p>
<p>Other parameters can also be specified; see <a href="https://arthurleroy.github.io/MagmaClustR/reference/train_magmaclust.html"><code>help (train_magmaclust)</code></a>
for details.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">model_clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/train_magmaclust.html">train_magmaclust</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">weight_train</span>,</span>
<span>                        nb_cluster <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                        kern_k <span class="op">=</span> <span class="st">"SE"</span>,</span>
<span>                        kern_i <span class="op">=</span> <span class="st">"SE"</span>,</span>
<span>                        common_hp_k <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                        common_hp_i <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; The 'ini_hp_i' argument has not been specified. Random values of hyper-parameters for the individual processes are used as initialisation.</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; The 'ini_hp_k' argument has not been specified. Random values of hyper-parameters for the mean processes are used as initialisation.</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; The 'prior_mean' argument has not been specified. The hyper_prior mean function is thus set to be 0 everywhere.</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 1: 16.91 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -614.01449 --- Convergence ratio = Inf</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 2: 9.41 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -490.95276 --- Convergence ratio = 0.25066</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 3: 12.96 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -431.92637 --- Convergence ratio = 0.13666</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 4: 10.18 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -399.90849 --- Convergence ratio = 0.08006</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 5: 8.34 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -392.73377 --- Convergence ratio = 0.01827</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 6: 9.97 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -389.33247 --- Convergence ratio = 0.00874</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 7: 6.97 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -387.01608 --- Convergence ratio = 0.00599</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 8: 7 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -385.18784 --- Convergence ratio = 0.00475</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 9: 6.97 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -383.4405 --- Convergence ratio = 0.00456</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 10: 7.12 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -381.78493 --- Convergence ratio = 0.00434</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 11: 6.93 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -380.30595 --- Convergence ratio = 0.00389</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 12: 7.12 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -379.03158 --- Convergence ratio = 0.00336</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 13: 7.08 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -378.03565 --- Convergence ratio = 0.00263</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 14: 7.1 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -377.25119 --- Convergence ratio = 0.00208</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 15: 6.93 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -376.71268 --- Convergence ratio = 0.00143</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 16: 7 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -376.31286 --- Convergence ratio = 0.00106</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; VEM algorithm, step 17: 7.01 seconds </span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Value of the elbo: -376.05438 --- Convergence ratio = 0.00069</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; The EM algorithm successfully converged, training is completed. </span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="prediction-for-james">Prediction for James<a class="anchor" aria-label="anchor" href="#prediction-for-james"></a>
</h3>
<p>As the <em>MagmaClust</em> model is trained, we can now predict the
evolution of James’ weight. To perform prediction, we need to specify
two main parameters in the <code><a href="../reference/pred_magmaclust.html">pred_magmaclust()</a></code> function:</p>
<ul>
<li>
<code>data</code>, in our case, the sub-dataset containing James’
past weight;</li>
<li>
<code>trained_model</code>, which corresponds to the model we just
trained with the other 20 children</li>
</ul>
<p>Let us mention that we aim to study weight curves during early
childhood, and compare our predictions to the true values observed in
the dataset. Therefore, the evolution of James’ weight is predicted
between 0 and 6 years (72 months), using only the his weight data from 0
to 20 months. Therefore, the argument
<code>grid_inputs = seq(0,72,0.1)</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_magmaclust.html">pred_magmaclust</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">weight_pred</span>,</span>
<span>                              trained_model <span class="op">=</span> <span class="va">model_clust</span>,</span>
<span>                              grid_inputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">72</span>,<span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                              plot <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                              get_hyperpost <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; The hyper-posterior distribution of the mean process provided in 'hyperpost' argument isn't evaluated on the expected inputs. Start evaluating the hyper-posterior on the correct inputs...</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; The 'prior_mean_k' argument has not been specified. The hyper-prior  mean functions are thus set to be 0 everywhere.</span></span>
<span><span class="co">#&gt;  </span></span>
<span><span class="co">#&gt; Done!</span></span>
<span><span class="co">#&gt; </span></span></code></pre></div>
<p>Here we specified <code>get_hyperpost = TRUE</code> (to return the
hyper-posterior distribution of all mean processes) as it will allow us
to plot the average GP of each cluster in the
<code><a href="../reference/plot_magmaclust.html">plot_magmaclust()</a></code> function. However, we do not need it if
we merely need to display the prediction of our individual.</p>
</div>
<div class="section level3">
<h3 id="plots">Plots<a class="anchor" aria-label="anchor" href="#plots"></a>
</h3>
<p>With the <a href="https://arthurleroy.github.io/MagmaClustR/reference/plot_magmaclust.html"><code>plot_magmaclust()</code></a>
function, we can display the prediction for the evolution of James’
weight over time.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_magmaclust.html">plot_magmaclust</a></span><span class="op">(</span>pred <span class="op">=</span> <span class="va">pred_clust</span>,</span>
<span>                data <span class="op">=</span> <span class="va">weight_pred</span>,</span>
<span>                prior_mean <span class="op">=</span> <span class="va">pred_clust</span><span class="op">$</span><span class="va">hyperpost</span><span class="op">$</span><span class="va">mean</span>,</span>
<span>                data_train <span class="op">=</span> <span class="va">weight_train</span>,</span>
<span>                size_data <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="how-to-use-magmaclust_files/figure-html/unnamed-chunk-10-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>In the above figure, we can observe:</p>
<ul>
<li><p>James’ evolution curve (purple line) expressed as a mixture of
GPs;</p></li>
<li><p>the training data points in the background (displayed through
<code>data_train</code>). Each colour corresponds to one child;</p></li>
<li><p>the trained mean processes as dashed (blue, red and green) lines
coming from the <code>prior_mean</code> parameter.</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="customise-graphs">Customise graphs<a class="anchor" aria-label="anchor" href="#customise-graphs"></a>
</h2>
<p>In order to customise the graphical representations of results, we
first need to distinguish 2 cases:</p>
<ul>
<li><p>James belongs to one of the clusters with probability 1 (or
really close). We can then display the mean curve along its associated
95% credibility interval;</p></li>
<li><p>James has non-null probabilities in several clusters; therefore,
its evolution curve is defined as a Gaussian mixture (which is not
unimodal in general). In this case, we cannot define an associated
credibility interval. However, the uncertainty quantification can still
be displayed using a heatmap of probabilities. To control the colour
pixel ratio of the heatmap, one can define an appropriate vector for the
<code>y_grid</code> argument.</p></li>
</ul>
<p>We can also display training individuals in the same colour as their
most probable cluster by using the <a href="https://arthurleroy.github.io/MagmaClustR/reference/data_allocate_cluster.html"><code>data_allocate_cluster()</code></a>
function beforehand, and specifying the following arguments:
<code>data_train = data_train_with_clust</code> and
<code>col_clust = TRUE</code>. In order to evaluate the quality of the
prediction, we can also represent (in grey below) the true observations
for this individual, which we didn’t use in the algorithm and kept in
the <code>weight_test</code> variable for testing purposes.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_train_with_clust</span> <span class="op">=</span> <span class="fu"><a href="../reference/data_allocate_cluster.html">data_allocate_cluster</a></span><span class="op">(</span><span class="va">model_clust</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_magmaclust.html">plot_magmaclust</a></span><span class="op">(</span>pred <span class="op">=</span> <span class="va">pred_clust</span>,</span>
<span>                cluster <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>                data <span class="op">=</span> <span class="va">weight_pred</span>,</span>
<span>                data_train <span class="op">=</span> <span class="va">data_train_with_clust</span>,</span>
<span>                prior_mean <span class="op">=</span> <span class="va">pred_clust</span><span class="op">$</span><span class="va">hyperpost</span><span class="op">$</span><span class="va">mean</span>,</span>
<span>                heatmap <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                y_grid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">37</span>,<span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                col_clust <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                size_data <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">weight_test</span>,</span>
<span>                      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Input</span>, y <span class="op">=</span> <span class="va">Output</span><span class="op">)</span>,</span>
<span>                      color <span class="op">=</span> <span class="st">'grey'</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="how-to-use-magmaclust_files/figure-html/unnamed-chunk-11-1.png" width="80%" style="display: block; margin: auto;"></p>
<div class="section level4">
<h4 id="magmaclust-vs-magma">MagmaClust vs Magma<a class="anchor" aria-label="anchor" href="#magmaclust-vs-magma"></a>
</h4>
<p>The MagmaClustR package also provides an implementation for the
<em>Magma</em> algorithm, allowing us to compare <em>MagmaClust</em> and
<em>Magma</em> predictions. For more details on Magma, see the dedicated
<a href="https://arthurleroy.github.io/MagmaClustR/articles/how-to-use-magma.html">vignette</a>.</p>
<p>The graphs below correspond to James’ weight prediction with
MagmaClust (left) and Magma (right).</p>
<p><img src="how-to-use-magmaclust_files/figure-html/unnamed-chunk-13-1.png" width="2187.5" style="display: block; margin: auto;"></p>
<p>On intervals of unobserved timestamps containing data points from the
training dataset (<span class="math inline">\(t \in ]20, 72]\)</span>),
Magma takes advantage of its multi-task component to share knowledge
across individuals by estimating a unique mean process. However, this
unique mean process appears unable to recover accurately the evolution
trend. In this example, <em>MagmaClust</em> offers a significant
improvement in this long term (more than 4 years ahead) forecasting
task. By leveraging group structures among children, the algorithm
shares more knowledge across individual that are similar, resulting in
more precise and specific predictions based on a mixture of GPs.</p>
</div>
</div>
<div class="section level2">
<h2 id="reference">Reference<a class="anchor" aria-label="anchor" href="#reference"></a>
</h2>
<p>Overall, the multi-task framework combined with a clustering
component provided by <em>MagmaClust</em> offers reliable probabilistic
predictions for a new individual (child in our example) on a wide range
of timestamps. Moreover, the uncertainty quantification inherent to
GP-based methods allows practitioners to maintain an adequate degree of
caution in their decision making process.</p>
<p>For further details, the complete derivation of the algorithm and
experiments are published and available in <a href="https://jmlr.org/papers/v24/20-1321.html" class="external-link">Cluster-Specific
Predictions with Multi-Task Gaussian Processes</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Arthur Leroy, Pierre Latouche.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
